syntax = "proto3";

package meproto.did.v1;

// ===========================
//  ENUMS
// ===========================

enum Algorithm {
  ALG_UNSPECIFIED = 0;
  ED25519        = 1;   // EdDSA / signature
  X25519         = 2;   // ECDH / key agreement
  ES256          = 3;   // P-256 / secp256r1 / DI proofs + ZK
  SECP256K1      = 4;   // Wallet keys (BTC/ETH)
  ML_DSA_87      = 5;   // PQ signature
  ML_KEM_1024    = 6;   // PQ key agreement (Kyber)
}

enum UserVerificationMethod {
  UVM_UNSPECIFIED = 0;
  NONE = 1;
  PIN = 2;
  PASSCODE = 3;
  PASSWORD = 4;
  FINGERPRINT = 5;
  FACE = 6;
  IRIS = 7;
  VOICE = 8;
  PATTERN = 9;
}

enum VerificationMethodType {
  VMT_UNSPECIFIED = 0;
  MULTIKEY = 1;
}

enum DomainVerificationMethod {
  DVM_UNSPECIFIED = 0;
  DNS_TXT = 1;
  HTTPS_WELL_KNOWN = 2;
}

// ===========================
//  VERIFICATION METHOD
// ===========================

message VerificationMethod {
  string id = 1;                     // "#ed25519"
  VerificationMethodType type = 2;   // MULTIKEY
  string controller = 3;             // DID subject
  bytes pk = 4;                      // multikey-encoded key
  Algorithm alg = 5;                 // ED25519, ML_DSA_87, ...
}

// ===========================
//  SERVICE
// ===========================

message Service {
  string id = 1;
  string type = 2;
  string version = 3;
  bytes service_endpoint = 4; // canonical JSON blob
}

// ===========================
//  ATTESTATION (core update signatures)
// ===========================

message Attestation {
  Algorithm alg = 1;               // ED25519 or ML_DSA_87
  string verification_method = 2;  // reference to verification method
  bytes sig = 3;                   // signature over canonical core CBOR
}

// ===========================
//  DATA INTEGRITY PROOF (P-256)
// ===========================

message DataIntegrityProof {
  string type = 1;               // "DataIntegrityProof"
  string cryptosuite = 2;        // "es256-jws-cid-2025"
  string verification_method = 3; // reference to verification method
  string created = 4;            // ISO8601 timestamp
  string jws = 5;                // compact JWS (the proof value)
}

// ===========================
//  DOMAIN VERIFICATION
// ===========================

message DomainVerification {
  DomainVerificationMethod method = 1;  // dns_txt or https_well_known
  string domain = 2;

  oneof binding {
    DNSBinding dns = 3;
    WellKnownBinding wellknown = 4;
  }
}

message DNSBinding {
  string record_name = 1;  // default: "_didme"
  string txt_value = 2;    // TXT record value (the DID)
}

message WellKnownBinding {
  string uri = 1;          // default: "/.well-known/didme"
  string content = 2;      // file content (the DID)
}

// ===========================
//  UPDATE POLICY
// ===========================

message UpdatePolicy {
  repeated string allowed = 1;          // VM IDs that MAY sign updates (OR semantics)
  repeated Algorithm required_alg = 2;  // Algorithms that MUST be present (AND semantics)
}

// ===========================
//  DID DOCUMENT
// ===========================

message DIDDocument {
  // Core identity
  string id = 1;
  string controller = 2;

  // @context
  repeated string context = 3;

  // Metadata
  repeated string also_known_as = 4;
  bool biometric = 5;
  bool hardware = 6;
  string device_model = 7; 
  UserVerificationMethod user_verification_method = 8;

  // Core state
  uint64 seq = 9;               // sequence
  string prev = 10;             // prior CID or empty
  string core = 11;             // currentCore CID
  bytes core_cbor = 12;         // canonical core object
  repeated string key_history = 13;

  // Verification relationships
  repeated VerificationMethod vm = 14;           // full VM set
  repeated string authentication = 15;
  repeated string assertion = 16;
  repeated string invocation = 17;  // capabilityInvocation
  repeated string key_agreement = 18;

  // Services
  repeated Service svc = 19;

  // Policy & attestations
  UpdatePolicy policy = 20;
  repeated Attestation att = 21;

  // Optional P-256 DataIntegrityProof
  DataIntegrityProof proof = 22;

  // Domain verification objects
  repeated DomainVerification dv = 23;
}