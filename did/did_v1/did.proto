syntax = "proto3";

package meproto.did.v1;

// ===========================
//  ENUMS
// ===========================

enum Algorithm {
  ALG_UNSPECIFIED = 0;
  ED25519        = 1;   // EdDSA / signature
  X25519         = 2;   // ECDH / key agreement
  ES256          = 3;   // P-256 / secp256r1 / DI proofs + ZK
  SECP256K1      = 4;   // Wallet keys (BTC/ETH)
  ML_DSA_87      = 5;   // PQ signature
  ML_KEM_1024    = 6;   // PQ key agreement (Kyber)
}

enum UserVerificationMethod {
  UVM_UNSPECIFIED = 0;
  NONE = 1;
  PIN = 2;
  PASSCODE = 3;
  PASSWORD = 4;
  FINGERPRINT = 5;
  FACE = 6;
  IRIS = 7;
  VOICE = 8;
  PATTERN = 9;
}

enum VerificationMethodType {
  VMT_UNSPECIFIED = 0;
  MULTIKEY = 1;
}

enum DomainVerificationMethod {
  DVM_UNSPECIFIED = 0;
  DNS_TXT = 1;
  HTTPS_WELL_KNOWN = 2;
}

// ===========================
//  VERIFICATION METHOD KEY
// ===========================

message VMKey {
  string id = 1;                            // e.g., "#ed25519"
  string controller = 2;                    // always DID subject for did:me
  VerificationMethodType type = 3;          // MULTIKEY
  Algorithm alg = 4;                        // e.g., ED25519, ML_DSA_87, etc.
  bytes pk = 5;                             // multikey-encoded public key (raw)
}

// ===========================
//  SERVICE
// ===========================

message Service {
  string id = 1;
  string type = 2;
  string version = 3;
  bytes service_data = 4; // JSON blob
}

// ===========================
//  ATTESTATION (core update signatures)
// ===========================

message Attestation {
  Algorithm alg = 1;               // ED25519 or ML_DSA_87
  string verification_method = 2;  // reference to VMKey.id
  bytes sig = 3;                   // signature over canonical core CBOR
}

// ===========================
//  DATA INTEGRITY PROOF (P-256)
// ===========================

message Proof {
  string id = 1;
  string type = 2;
  string cryptosuite = 3;   // e.g., "es256-jws-cid-2025"
  string purpose = 4;       // assertionMethod
  string vm = 5;            // VMKey.id reference
  string created = 6;       // ISO8601 timestamp
  string jws = 7;           // compact JWS
}

// ===========================
//  DOMAIN VERIFICATION
// ===========================

message DomainVerification {
  DomainVerificationMethod method = 1;
  string domain = 2;

  oneof binding {
    DNSBinding dns = 3;
    WellKnownBinding wellknown = 4;
  }
}

message DNSBinding {
  string record_name = 1;   // default: "_didme"
  string txt_value = 2;     // TXT record value
}

message WellKnownBinding {
  string uri = 1; // default: "/.well-known/didme"
  string content = 2;
}

// ===========================
//  UPDATE POLICY
// ===========================

message UpdatePolicy {
  repeated string allowed = 1;         // VM ids that MAY sign updates (OR list)
  repeated Algorithm required_alg = 2; // Algorithms that MUST be present (AND list)
}

// ===========================
//  DID DOCUMENT
// ===========================

message DIDDocument {
  // Core identity
  string id = 1;
  string controller = 2;

  // @context
  repeated string ctx = 3;

  // Metadata
  repeated string also_known_as = 4;
  bool biometric = 5;
  bool hardware = 6;
  string device_model = 7; 
  UserVerificationMethod user_verification_method = 8;

  // Core state
  uint64 seq = 9;               // sequence
  string prev = 10;             // prior CID or empty
  string core = 11;             // currentCore CID
  bytes core_cbor = 12;         // canonical core object
  repeated string key_history = 13;

  // Verification relationships
  repeated VMKey vm = 14;           // full VM set
  repeated string authentication = 15;
  repeated string assertion = 16;
  repeated string invocation = 17;  // capabilityInvocation
  repeated string key_agreement = 18;

  // Services
  repeated Service svc = 19;

  // Policy & attestations
  UpdatePolicy policy = 20;
  repeated Attestation att = 21;

  // Optional P-256 DataIntegrityProof
  Proof proof = 22;

  // Domain verification objects
  repeated DomainVerification dv = 23;
}